---
title: "Create a custom output component"
date: 2020-11-10
weight: 710
---
Output components in Baker receive records at the end of the filter chain and are in charge of
storing them, eventually sending the result (like a temporary file in the disk) to an Upload
component.

To create an output and make it available to Baker, one must:

* Implement the [Output](https://pkg.go.dev/github.com/AdRoll/baker#Output) interface
* Add an [`OutputDesc`](https://pkg.go.dev/github.com/AdRoll/baker#OutputDesc) for the output to
the available outputs in [`Components`](https://pkg.go.dev/github.com/AdRoll/baker#Components)

## The Output interface

```go
type Output interface {
	Run(in <-chan OutputRecord, upch chan<- string) error
	Stats() OutputStats
	CanShard() bool
}
```

The [Output interface](https://pkg.go.dev/github.com/AdRoll/baker#Output) must be implemented when
creating a new output component.

The `Run` function implements the component logic and gets a channel where it receives
[OutputRecord](https://pkg.go.dev/github.com/AdRoll/baker#OutputRecord) objects and a channel to
communicate to the Upload components what to upload.

`CanShard` is the function telling whether the output is able to manage sharding. Read the page
[dedicated to the sharding](/docs/how-to/sharding/) to go deeper in the topic.

`Stats` is used to collect metrics, see the [dedicated page](/docs/how-to/metrics/).

## OutputDesc

```go
var MyOutputDesc = baker.OutputDesc{
	Name:   "MyOutput",
	New:    NewMyOutput,
    Config: &MyOutputConfig{},
    Raw:    true,
	Help:   "High-level description of MyOutput",
}
```

This object has a `Name`, that is used in the Baker configuration file to identify the output,
a constructor-like function (`New`), a config object (used to parse the output configuration in the
TOML file) and a help text that must help the users to use the component and its configuration
parameters. The `Raw` field tells whether the output expects to receive raw records in addition
to single fields (see below for details).

### Output constructor-like function

The `New` key in the `OutputDesc` object represents the constructor-like function.

The function receives an [OutputParams](https://pkg.go.dev/github.com/AdRoll/baker#OutputParams)
object and returns an instance of [Output](https://pkg.go.dev/github.com/AdRoll/baker#Output).

`OutputParams` contains the index of the output and the fields `FieldIndex` that the output will
receive during processing, in addition to the fields inherited from
[ComponentParams](https://pkg.go.dev/github.com/AdRoll/baker#ComponentParams).

`OutputParams.Index` indicates a unique index of the output process among the concurrent output
processes generated by Baker. The `procs` configuration can be used to tune the total number of
concurrent processes, see [Pipeline configuration](/docs/how-to/pipeline_configuration/) for details.  
Note that the output should extensively document in `OutputDesc.Help` if it is able to manage
concurrent processing or the user should configure it with a single process (`procs=1`).
Read [Tuning concurrency](/docs/how-to/concurrency/) for an in-depth study on the subject.

`OutputParams.Fields` is a list of [FieldIndex](https://pkg.go.dev/github.com/AdRoll/baker#FieldIndex)
that the output will receive. Their position in this slice correspond to the fields in
[OutputRecord.Fields](https://pkg.go.dev/github.com/AdRoll/baker#OutputRecord), see below for
details.  
If, for any reason, the output needs to retrieve the fields name (like the SQLite output does to
get the columns names), then `OutputParams.FieldName` can be used.

### The output configuration and help

The output configuration object (`MyOutputConfig` in the previous example) must export all
configuration parameters that the user can set in the TOML topology file.

Each key in the struct must include a `help` string tag and a `required` boolean tag, both are
mandatory.

The former helps the user to understand the possible values of the field, the latter tells Baker
whether to refuse a missing configuration param.

## OutputRecord

The [OutputRecord](https://pkg.go.dev/github.com/AdRoll/baker#OutputRecord) channel received by
the output component is closed by Baker when all the records have been processed (in case of a batch
execution) or when an interruption starts (in case of a SIGINT signal from the user).

Until that moment, the output component must continuosly read new records, processing them.

The `OutputRecord.Fields` slice contains the string values of the fields that the user choose to
send to the output configuring the
[`fields` key](http://localhost:1313/docs/how-to/pipeline_configuration/#components-configuration)
in the `[output]` section of the TOML topology file.

The fields positions correspond to the `FieldIndex` received in `OutputParams.Fields` by the
component constructor-like function.

In case of a raw output, `OutputRecord.Record` contains the full record as a byte slice.  
The presence of raw data doesn't change the fields field value, that depend on the output
configuration in the TOML file.

## Prepare data for uploading

The output component must always send the produced output to the upload component, that is optional
but its presence is unknown to the output.

The upload channel receives strings, that should represent a path to a local file containing the
processed records. The output can send a single message at the end of its job (think to a sqlite
database that should only be uploaded before Baker exits) or can upload files periodically, like
the [FileWriter](https://github.com/AdRoll/baker/blob/main/output/filewriter.go) component does
when it rotates (i.e. it stops writing to a file, send its path to the upload, and then creates
a new file).
